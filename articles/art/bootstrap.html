<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metrics.in.r">
<title>Bootstrap and Quantile Regression • metrics.in.r</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Bootstrap and Quantile Regression">
<meta property="og:description" content="metrics.in.r">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">metrics.in.r</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../articles/metrics-in-r.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../../articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nateybear/metrics-in-r/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Bootstrap and Quantile Regression</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nateybear/metrics-in-r/blob/HEAD/vignettes/art/bootstrap.Rmd" class="external-link"><code>vignettes/art/bootstrap.Rmd</code></a></small>
      <div class="d-none name"><code>bootstrap.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-idea-a-bit-of-magic">The Idea: A Bit of Magic<a class="anchor" aria-label="anchor" href="#the-idea-a-bit-of-magic"></a>
</h2>
<p>When you first learn about the bootstrap, it may seem a little magical. You seem to get a lot for free, in that you <em>only</em> need to resample your data a bunch of times in order to get a sampling distribution of any statistic you like.</p>
<p><strong>Definition:</strong> Recall that we believe there is a “true value” of a population-level in the statistic. That is, the mean is a (unknown) number, <span class="math inline">\(\beta\)</span> coefficients are true (unknown) numbers. The uncertainty in estimating <span class="math inline">\(\beta\)</span> comes from the fact that we only have a finite sample from the entire population. If we imagine drawing many samples of length <span class="math inline">\(N\)</span> from the population, then intuitively we know that you will get different values of <span class="math inline">\(\beta\)</span> for each sample. This distribution of <span class="math inline">\(\beta\)</span>s is called the <strong>sampling distribution</strong>. It is the distribution of a statistic due to sampling variation.</p>
<p>I want to emphasize two points, and then we’ll move onto coding.</p>
<div class="section level3">
<h3 id="the-sample-analogue-and-wlln">The “Sample Analogue” and WLLN<a class="anchor" aria-label="anchor" href="#the-sample-analogue-and-wlln"></a>
</h3>
<p>When you bootstrap something, what you get back is a bunch of numbers. Those numbers are a random sample from a distribution! It is a random sample from the sampling distribution of <span class="math inline">\(\beta\)</span>.</p>
<p>To “conduct inference” on the <span class="math inline">\(\beta\)</span>s, we just need to ask questions about this sample of <span class="math inline">\(\beta\)</span>s that we’re given. This a fundamentally different way of doing statistical inference than the classical way of saying that <span class="math inline">\(\beta\)</span>s are normally distributed with some distribution and then using critical values from the standard normal to accept/reject a hypothesis.</p>
<p>The law of large numbers along with the continuous mapping theorem gives us a lot of power. This basically tells us that we can take the average value of some function <span class="math inline">\(g\)</span> in our sample of <span class="math inline">\(\beta\)</span>s, and this is a good estimate of the true value of <span class="math inline">\(g\)</span> in the entire population. Formally we write</p>
<p><span class="math display">\[
\frac{1}{B} \sum_{i=1}^B g(\beta_i) \overset{p}\rightarrow g(\beta)
\]</span></p>
<p>I also want to point out that this <strong>sample analogue</strong> technique intuitively applies to other situations. The sample median of our <span class="math inline">\(\beta\)</span>s is a pretty good guess of the population median. The 5%-95% interval of our sample of <span class="math inline">\(\beta\)</span>s is a pretty good estimate of that 90% interval on the true value of <span class="math inline">\(\beta\)</span>.</p>
<p>Let’s make this more concrete. Say we are bootstrapping OLS coefficients from some regression, and we want to estimate the “turning point” of mage from Problem Set 2. We take all of these <span class="math inline">\(\beta\)</span> samples and construct</p>
<p><span class="math display">\[
\theta_i \equiv -\beta_{mage}^i/(2\beta_{magesq}^i)
\]</span></p>
<p>And now we can think of these <span class="math inline">\(\theta_i\)</span> as draws from the sampling distribution of the turning point. If we take the mean of these <span class="math inline">\(\theta_i\)</span>, this is an estimate of the mean value of the turning point. If we take the 5th and 95th percentiles of the <span class="math inline">\(\theta_i\)</span>, this is a 90% confidence interval on the true value of the turning point.</p>
<p>Conclusion: With bootstrapping, you are generating a random sample of a <em>statistic</em> from a finite amount of data. This is the magic of resampling. To emphasize the generality, let me expand your idea of a statistic.</p>
</div>
<div class="section level3">
<h3 id="bootstrap-works-for-any-statistic">Bootstrap Works for Any Statistic<a class="anchor" aria-label="anchor" href="#bootstrap-works-for-any-statistic"></a>
</h3>
<p><strong>Defintion:</strong> A statistic is a function that takes in a sample of data and returns <em>something</em>. What that something is is very general. You can think about a statistic as an OLS coefficient (data in, linear regression out), or sample mean, or sample variance.</p>
<p>But you can also think bigger: nonparametric statistics, like kernel regression estimators, machine learning models… you don’t have to return a number, you can return a function, a data structure, basically anything that you can program. It truly doesn’t matter, if you can think of <em>any</em> sort of thing that takes in data and produces some output, then you can use the bootstrap to quantify the <em>amount of uncertainty</em> in the output.</p>
</div>
</div>
<div class="section level2">
<h2 id="how-to-code-it">How to Code It<a class="anchor" aria-label="anchor" href="#how-to-code-it"></a>
</h2>
<p>As an example: We want to bootstrap the median wage in the HTV dataset.</p>
<p>Since bootstrapping is computationally straightforward, there’s nothing stopping you from doing it yourself. You just need a for loop:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org" class="external-link">haven</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read in the data</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html" class="external-link">read_dta</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"HTV.DTA"</span>, package <span class="op">=</span> <span class="st">"metrics.in.r"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wage</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">wage</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make a vector to hold the output</span></span>
<span><span class="va">median_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">wage_resample</span> <span class="op">&lt;-</span> <span class="va">wage</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">median_samples</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">wage_resample</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot a histogram of the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">median_samples</span>, prob <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">median_samples</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">median_samples</span><span class="op">)</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="bootstrap_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>I overlayed a normal curve in the output above to show you that the median doesn’t look very normal! This might suggest that we would be better suited using the boostrap to answer statistical questions about it.</p>
<div class="section level3">
<h3 id="there-are-packages-for-that">There are packages for that<a class="anchor" aria-label="anchor" href="#there-are-packages-for-that"></a>
</h3>
<p>One package that I really like for bootstrapping is <code>mosaic</code>. It add special syntax for doing stats that feels pretty intuitive. You can read more about it <a href="https://www.mosaic-web.org/mosaic/articles/Resampling.html" class="external-link">here</a>.</p>
<p>The equivalent code for mosaic looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ProjectMOSAIC/mosaic" class="external-link">mosaic</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">median_samples</span> <span class="op">&lt;-</span> <span class="fu">do</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://www.mosaic-web.org/mosaic/reference/aggregating.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://www.mosaic-web.org/mosaic/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>There’s another package that I learned before mosaic called <code>boot</code>. It has a function called <code>boot</code> that works slightly differently. You give it the data to resample, and a function to compute the statistic. Documentation <a href="https://www.rdocumentation.org/packages/boot/versions/1.3-28/topics/boot" class="external-link">here</a>. What it would look like is:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span><span class="va">wage</span>, <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, R <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## boot(data = wage, statistic = function(data, i) median(data[i]), </span></span>
<span><span class="co">##     R = 1000)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Bootstrap Statistics :</span></span>
<span><span class="co">##     original     bias    std. error</span></span>
<span><span class="co">## t1*  11.5429 0.06200778   0.2208038</span></span></code></pre>
<p>Notice that it doesn’t return a numeric vector like mosaic or the DIY versions, but instead a “boot object” that will print a summary of the bootstrap procedure.</p>
</div>
</div>
<div class="section level2">
<h2 id="enter-quantile-regression">Enter Quantile Regression<a class="anchor" aria-label="anchor" href="#enter-quantile-regression"></a>
</h2>
<p>Why talk about quantile regression and bootstrap in the same article? Because quantile regression is a great example of something that is much easier to bootstrap than to do classical statistics.</p>
<p>Quantile regression can be done in R using the <code>quantreg</code> package. It was written by Roger Koenker, one of the fathers of quantile regression.</p>
<p>You can create a quantile regression model much like a linear model in R, but the appropriate function is <code>rq</code>. It also takes an additional argument, <code>tau</code>, which are the quantiles that you want to estimate.</p>
<p>Let’s create a quantile regression model that looks at the effects of education, ability, and experience on wage at two different quantiles:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.r-project.org" class="external-link">quantreg</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/quantreg/man/rq.html" class="external-link">rq</a></span><span class="op">(</span><span class="va">wage</span> <span class="op">~</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">abil</span> <span class="op">+</span> <span class="va">exper</span>, data <span class="op">=</span> <span class="va">data</span>, tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## rq(formula = wage ~ educ + abil + exper, tau = c(0.25, 0.75), </span></span>
<span><span class="co">##     data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##              tau= 0.25   tau= 0.75</span></span>
<span><span class="co">## (Intercept) -2.5251534 -12.2843990</span></span>
<span><span class="co">## educ         0.6169045   1.5504339</span></span>
<span><span class="co">## abil         0.5356258   0.7071306</span></span>
<span><span class="co">## exper        0.1940122   0.6063321</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Degrees of freedom: 1230 total; 1226 residual</span></span></code></pre>
<div class="section level3">
<h3 id="its-a-matrix-whats-the-variance-of-a-matrix">It’s a matrix? What’s the variance of a matrix?<a class="anchor" aria-label="anchor" href="#its-a-matrix-whats-the-variance-of-a-matrix"></a>
</h3>
<p>Our coefficient estimates are now stored in a matrix! Our OLS coefficients were a vector, so we’ve added a dimension here for each <code>tau</code>. Random matrices are kind of a complicated thing. It’s easier to think about a <span class="math inline">\(m\times n\)</span> random matrix as a <span class="math inline">\(m*n\)</span> length vector. That way, the covariance matrix of quantile regression coefficients is a <span class="math inline">\((m*n)\times (m*n)\)</span>-dimensional matrix.</p>
<p>Surely Roger Koenker, the father of quantile regression, realizes this.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in UseMethod("vcov"): no applicable method for 'vcov' applied to an object of class "rqs"</span></span></code></pre>
<p>Well, it’s not great that it doesn’t provide a <code>vcov</code> implementation out of the box. At least he provides a summary method for the models:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call: rq(formula = wage ~ educ + abil + exper, tau = c(0.25, 0.75), </span></span>
<span><span class="co">##     data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## tau: [1] 0.25</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##             Value    Std. Error t value  Pr(&gt;|t|)</span></span>
<span><span class="co">## (Intercept) -2.52515  1.92828   -1.30954  0.19060</span></span>
<span><span class="co">## educ         0.61690  0.11196    5.50995  0.00000</span></span>
<span><span class="co">## abil         0.53563  0.08522    6.28542  0.00000</span></span>
<span><span class="co">## exper        0.19401  0.07378    2.62954  0.00866</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call: rq(formula = wage ~ educ + abil + exper, tau = c(0.25, 0.75), </span></span>
<span><span class="co">##     data = data)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## tau: [1] 0.75</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##             Value     Std. Error t value   Pr(&gt;|t|) </span></span>
<span><span class="co">## (Intercept) -12.28440   2.56243   -4.79405   0.00000</span></span>
<span><span class="co">## educ          1.55043   0.14868   10.42786   0.00000</span></span>
<span><span class="co">## abil          0.70713   0.12675    5.57891   0.00000</span></span>
<span><span class="co">## exper         0.60633   0.10479    5.78601   0.00000</span></span></code></pre>
<p><strong>The Problem</strong>: The package doesn’t compute covariances <em>across quantiles</em>. So there is no way for us to do post-estimation like <code>testnl</code> or <code>lincom</code>. Let’s step back and discuss the way forward.</p>
</div>
</div>
<div class="section level2">
<h2 id="matrix-gumming-up-the-machinery">Matrix Gumming up the Machinery<a class="anchor" aria-label="anchor" href="#matrix-gumming-up-the-machinery"></a>
</h2>
<p>The fundamental problem is that our coefficients being a matrix is a scenario that none of our tools have accounted for.</p>
<p>Sandwich tends to be very flexible to the type of model, but with quantile regressions it messes up the dimensions in one of the matrix multiplications:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/" class="external-link">sandwich</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovBS.html" class="external-link">vcovBS</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in rval + sign[i] * cov(cf, use = use): non-conformable arrays</span></span></code></pre>
<p>Mosaic also has some nice tools for bootstrapping models, but it doesn’t quite work for quantile regressions either. Compare this:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mosaic_out</span> <span class="op">&lt;-</span> <span class="fu">do</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">wage</span> <span class="op">~</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">abil</span> <span class="op">+</span> <span class="va">exper</span>, data <span class="op">=</span> <span class="fu"><a href="https://www.mosaic-web.org/mosaic/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">mosaic_out</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        name       lower       upper level     method    estimate</span></span>
<span><span class="co">## 1 Intercept -23.5429851  -9.8515091  0.95 percentile -16.6397660</span></span>
<span><span class="co">## 2      educ   1.2936295   2.1335038  0.95 percentile   1.7015644</span></span>
<span><span class="co">## 3      abil   0.2788612   0.6957152  0.95 percentile   0.4879376</span></span>
<span><span class="co">## 4     exper   0.4238085   0.8580785  0.95 percentile   0.6393264</span></span>
<span><span class="co">## 5     sigma   7.2844127   9.3494740  0.95 percentile   8.3210291</span></span>
<span><span class="co">## 6 r.squared   0.1305195   0.2012573  0.95 percentile   0.1625965</span></span>
<span><span class="co">## 7         F  61.3457908 102.9707868  0.95 percentile  79.3497685</span></span></code></pre>
<p>To this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mosaic_out</span> <span class="op">&lt;-</span> <span class="fu">do</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/quantreg/man/rq.html" class="external-link">rq</a></span><span class="op">(</span></span>
<span>    <span class="va">wage</span> <span class="op">~</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">abil</span> <span class="op">+</span> <span class="va">exper</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://www.mosaic-web.org/mosaic/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>    tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">mosaic_out</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] name   lower  upper  level  method</span></span>
<span><span class="co">## &lt;0 rows&gt; (or 0-length row.names)</span></span></code></pre>
<p>It’s clear that we have to be a little inventive about our coding in order to make quantile regression work like the linear regression that we’re used to.</p>
</div>
<div class="section level2">
<h2 id="solution-1-change-what-youre-bootstrapping">Solution 1: Change What You’re bootstrapping<a class="anchor" aria-label="anchor" href="#solution-1-change-what-youre-bootstrapping"></a>
</h2>
<p>On the one hand, you’ll probably be interested in some specific function of the <span class="math inline">\(\beta\)</span>s, so you can change what you’re bootstrapping. That makes it amenable to using mosaic to conduct inference. For example, you might be interested in the difference in returns to experience for the 75th percentile of earners as opposed to the 25th. In other words, you care about the value of <span class="math inline">\(\beta_{exper(0.75)} - \beta_{exper(0.25)}\)</span>. You could just bootstrap it:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diff_pe_exper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/quantreg/man/rq.html" class="external-link">rq</a></span><span class="op">(</span><span class="va">wage</span> <span class="op">~</span> <span class="va">abil</span> <span class="op">+</span> <span class="va">exper</span> <span class="op">+</span> <span class="va">educ</span>, data <span class="op">=</span> <span class="va">data</span>, tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pe_exper_0.25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="st">"exper"</span>, <span class="st">"tau= 0.25"</span><span class="op">]</span></span>
<span>    <span class="va">pe_exper_0.75</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="st">"exper"</span>, <span class="st">"tau= 0.75"</span><span class="op">]</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pe_exper_0.75</span> <span class="op">-</span> <span class="va">pe_exper_0.25</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">diff_pe_expers</span> <span class="op">&lt;-</span> <span class="fu">do</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span> <span class="op">*</span> <span class="fu">diff_pe_exper</span><span class="op">(</span><span class="fu"><a href="https://www.mosaic-web.org/mosaic/reference/resample.html" class="external-link">resample</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">diff_pe_expers</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            name     lower    upper level     method estimate</span></span>
<span><span class="co">## 1 diff_pe_exper 0.2298966 0.597413  0.95 percentile  0.41232</span></span></code></pre>
<p>The output tells us that expected returns to experience are about 20 to 60 cents higher for higher earners than lower earners, HAEF. This solution is pretty straightforward, as long as you know <em>a priori</em> what function of the <span class="math inline">\(\beta\)</span>s you’re interested in.</p>
</div>
<div class="section level2">
<h2 id="solution-2-implement-a-new-vcov-function">Solution 2: Implement a new <code>vcov</code> function<a class="anchor" aria-label="anchor" href="#solution-2-implement-a-new-vcov-function"></a>
</h2>
<p>If you’re a big fan of <code>test</code>, <code>lincom</code>, and friends, then the above solution won’t work for you. You’re still lacking a way to get a variance matrix of your <span class="math inline">\(\beta\)</span>s. Here’s where I help you out. If you load the <code>metrics.in.r</code> package, I implement new default methods to get the covariance matrix of a quantile regression model. It’s not super fancy, it just converts the matrix of coefficients into a vector of coefficients, like this:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nateybear/metrics-in-r" class="external-link">metrics.in.r</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">normalized_coef</span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (Intercept)[0.25]        educ[0.25]        abil[0.25]       exper[0.25] </span></span>
<span><span class="co">##        -2.5251534         0.6169045         0.5356258         0.1940122 </span></span>
<span><span class="co">## (Intercept)[0.75]        educ[0.75]        abil[0.75]       exper[0.75] </span></span>
<span><span class="co">##       -12.2843990         1.5504339         0.7071306         0.6063321</span></span></code></pre>
<p>Then when you run <code>vcov</code> on the model, those are the names in the covariance matrix. Use the <code>R</code> parameter to change the number of bootstrap iterations:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">model</span>, R <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                   (Intercept)[0.25]   educ[0.25]    abil[0.25]  exper[0.25]</span></span>
<span><span class="co">## (Intercept)[0.25]       4.208016340 -0.209588384  0.0045265651 -0.150040209</span></span>
<span><span class="co">## educ[0.25]             -0.209588384  0.012218378 -0.0018597120  0.005645119</span></span>
<span><span class="co">## abil[0.25]              0.004526565 -0.001859712  0.0059575987  0.001093977</span></span>
<span><span class="co">## exper[0.25]            -0.150040209  0.005645119  0.0010939772  0.007466726</span></span>
<span><span class="co">## (Intercept)[0.75]       2.609634688 -0.150952105  0.0653030519 -0.074793204</span></span>
<span><span class="co">## educ[0.75]             -0.134643529  0.009008500 -0.0054146739  0.002589119</span></span>
<span><span class="co">## abil[0.75]              0.005692779 -0.002440167  0.0067005131  0.001634878</span></span>
<span><span class="co">## exper[0.75]            -0.086745785  0.003783915 -0.0005358332  0.003894305</span></span>
<span><span class="co">##                   (Intercept)[0.75]   educ[0.75]    abil[0.75]   exper[0.75]</span></span>
<span><span class="co">## (Intercept)[0.25]        2.60963469 -0.134643529  0.0056927788 -0.0867457848</span></span>
<span><span class="co">## educ[0.25]              -0.15095211  0.009008500 -0.0024401671  0.0037839151</span></span>
<span><span class="co">## abil[0.25]               0.06530305 -0.005414674  0.0067005131 -0.0005358332</span></span>
<span><span class="co">## exper[0.25]             -0.07479320  0.002589119  0.0016348783  0.0038943045</span></span>
<span><span class="co">## (Intercept)[0.75]        7.35441246 -0.447378446  0.1733159347 -0.1899327309</span></span>
<span><span class="co">## educ[0.75]              -0.44737845  0.030962091 -0.0170753178  0.0079498594</span></span>
<span><span class="co">## abil[0.75]               0.17331593 -0.017075318  0.0241210567  0.0008986141</span></span>
<span><span class="co">## exper[0.75]             -0.18993273  0.007949859  0.0008986141  0.0088582642</span></span></code></pre>
<p><strong>Putting it all together</strong>: With this machinery in place, we can use the <code>lincom</code> command to run the same comparison above, of the returns to experience for high vs. low earners:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/lincom.html">lincom</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">`exper[0.75]`</span> <span class="op">-</span> <span class="va">`exper[0.25]`</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 5</span></span></span>
<span><span class="co">##   Expression                    Estimate `Std. Error` `t-Value` `Pr(&gt;|t|)`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> `exper[0.75]` - `exper[0.25]`    0.412       0.089<span style="text-decoration: underline;">9</span>      4.58 0.000<span style="text-decoration: underline;">005</span>01</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="conclusion-and-comparison-of-solutions">Conclusion and Comparison of Solutions<a class="anchor" aria-label="anchor" href="#conclusion-and-comparison-of-solutions"></a>
</h2>
<p>First, note that solution 2 is a normal-based boostrap approach. We get the covariance matrix of the parameters by bootstrap, but then use normal-based asymptotics in our <code>test</code> and <code>lincom</code> commands. Solution 1 is completely non-parametric, as we are making no such distributional assumption when getting bootstrap samples of our statistic.</p>
<p>In some ways solution 2 feels a little heavier, because we have to change the “machinery” in order to account for the weirdness of quantile regression models. On the other hand, now it “just works” just like linear models. Solution 1 requires a little more finagling and tailoring to get our code right, and in that way could be more prone to user error.</p>
<p>In the end, this illustrates a trade-off in computer programming. It’s certainly attractive to design a system with complex interacting parts, such that the end result for the user is extremely simple and intuitive code—think Solution 2, or the tidyverse. There is a lot of burden on the designers in these systems, for example when something like quantile regression inevitably comes along and turns into a pain point for users. Then it falls on the designers to create a way for quantile regression to fit into their tidy system, which can involve difficult, sometimes painful trade-offs with the code that gets written.</p>
<p>The other approach is to be more “libertarian” as a designer and leave more in the user’s control. This is like Solution 1, where as a user you have to understand how to shape a quantile regression model in such a way that you can use mosaic with it. I would say it’s more “bulletproof” as a design philosophy, but you’re also probably giving some users enough rope to hang themselves with.</p>
<p>The real world is not black and white, so it’s hard to neatly categorize any R package as fitting into one or the other of these buckets. However, I think this is an important distinction to make, and as you gain more experience as a programmer it helps you to start framing the decisions that package creators make and understand what trade-offs they were weighing.</p>
<hr>
<p>Happy Coding!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nathan Gardner Hattersley.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
